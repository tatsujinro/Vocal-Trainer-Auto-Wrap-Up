name: è‡ªå‹•æ‰“åŒ…è²æ¨‚æ•™ç·´ HTML

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ main åˆ†æ”¯æœ‰ä»£ç¢¼æ¨é€æ™‚
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è¨±æ‰‹å‹•æŒ‰æŒ‰éˆ•è§¸ç™¼

permissions:
  contents: write # å…è¨±æ©Ÿå™¨äººä¿®æ”¹å€‰åº«å…§å®¹

jobs:
  build:
    runs-on: ubuntu-latest # ä½¿ç”¨ Ubuntu è™›æ“¬æ©Ÿ

    steps:
      # 1. æŠŠå€‰åº«çš„ä»£ç¢¼æŠ“ä¸‹ä¾†
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. å®‰è£ Python ç’°å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. åŸ·è¡Œä½ çš„ Python æ‰“åŒ…è…³æœ¬
      - name: Run Python Builder
        run: |
          # é€™è£¡å¡«å¯«ä½ ä¸Šå‚³çš„ Python æª”åï¼Œä¾‹å¦‚ build_offline_app.py
          python build_offline_app.py

      # 4. éƒ¨ç½²èˆ‡å°å­˜ç‰ˆæœ¬ (æ™ºæ…§å‹•æ…‹æŠ“å–ç‰ˆ)
      - name: Deploy and Archive Version
        run: |
          # è¨­å®š Git æ©Ÿå™¨äººèº«ä»½
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # --- ğŸ§  æ ¸å¿ƒä¿®æ”¹ï¼šæ™ºæ…§æŠ“å–é‚è¼¯ ---
          # ls -t: æŒ‰æ™‚é–“æ’åº (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
          # head -n 1: åªå–ç¬¬ä¸€è¡Œ (ä¹Ÿå°±æ˜¯æœ€æ–°çš„é‚£å€‹)
          TARGET_FILE=$(ls -t VocalTrainer_Offline_*.html | head -n 1)

          # --- ğŸ›¡ï¸ å®‰å…¨æª¢æŸ¥ ---
          # -z ä»£è¡¨å­—ä¸²æ˜¯ç©ºçš„ (æ²’æŠ“åˆ°æª”æ¡ˆ)
          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä»»ä½• VocalTrainer_Offline é–‹é ­çš„ HTML æª”æ¡ˆï¼"
            echo "è«‹æª¢æŸ¥ Python è…³æœ¬æ˜¯å¦æˆåŠŸåŸ·è¡Œä¸¦å¯«å…¥æª”æ¡ˆã€‚"
            ls -R # åˆ—å‡ºæ‰€æœ‰æª”æ¡ˆå¹«å¿™é™¤éŒ¯
            exit 1 # å¼·åˆ¶å ±éŒ¯åœæ­¢
          fi

          echo "âœ… è‡ªå‹•åµæ¸¬åˆ°æœ€æ–°ç‰ˆæœ¬: $TARGET_FILE"

          # --- ğŸšš é–‹å§‹æ¬é‹ ---
          # è¤‡è£½ä¸€ä»½è®Šæˆ index.html (è¦†è“‹èˆŠçš„)
          cp -f "$TARGET_FILE" index.html

          # æŠŠã€Œæœ€æ–°ç‰ˆè™Ÿæª”æ¡ˆã€å’Œã€Œé¦–é ã€éƒ½åŠ å…¥ Git
          git add "$TARGET_FILE"
          git add index.html

          # æäº¤ä¸¦æ¨é€
          # æäº¤è¨Šæ¯æœƒè‡ªå‹•å¸¶å…¥æŠ“åˆ°çš„æª”åï¼Œæ–¹ä¾¿ä½ ä»¥å¾ŒæŸ¥é–±
          git commit -m "Auto-deploy: $TARGET_FILE" || echo "âš ï¸ æ²’æœ‰è®Šæ›´å¯æäº¤"
          git push
